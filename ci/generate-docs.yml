---
platform: linux
image_resource:
  type: registry-image
  source:
    repository: karlkfi/concourse-dcind
inputs:
  - name: api-gw-image
  - name: task-image
outputs:
  - name: public
run:
  path: entrypoint.sh
  args:
    - bash
    - -ceux
    - |
      docker load -i api-gw-image/image.tar
      docker tag "$(cat api-gw-image/digest)" api-gw

      docker load -i task-image/image.tar

      docker network create docs

      docker run -d --name api-gw --network docs \
        -e APIGW_VALIDATE_JWT=false \
        -e APIGW_SCHEMA_PATH=/opt/schema/*.graphql \
        -e APIGW_SKIP_DB=true \
        -e NSO_BASE_URL= \
        -e NSO_RESTCONF_BASE_URL= \
        -e LINKMETRICS_GRPC_ADDR= \
        -e DEVREPO_GRPC_ADDR= \
        -e SERMGR_GRPC_ADDR= \
        -e DEVMGR_GRPC_ADDR= \
        -e SETTINGS_GRPC_ADDR= \
        api-gw

      docker run --network docs -v "$PWD"/public:/public \
        registry.nearbycomputing.com/nbycomp/core/api-gateway/docs-task
